<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多题库抽查复习系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        h3 {
            color: #444;
            margin: 15px 0;
            font-size: 18px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            resize: vertical;
        }
        textarea {
            min-height: 100px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        .review-area, .bank-management {
            display: none; /* 默认隐藏复习区和题库管理 */
        }
        .question-card {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .question-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .answer-content {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none; /* 默认隐藏答案 */
        }
        .status {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 16px;
        }
        .tip {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-item {
            display: flex;
            align-items: center;
        }
        .radio-item input {
            width: auto;
            margin-right: 5px;
        }
        /* 题库列表样式 */
        .bank-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .bank-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bank-item:last-child {
            border-bottom: none;
        }
        .bank-name {
            font-weight: 500;
            color: #333;
        }
        .bank-actions {
            display: flex;
            gap: 5px;
        }
        .bank-actions .btn {
            padding: 5px 10px;
            font-size: 14px;
            margin: 0;
        }
        .hidden-file-input {
            display: none;
        }
        .current-bank {
            background: #e9f7fe;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #138496;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- 题库管理区 -->
    <div class="container bank-management" id="bank-management">
        <h2>题库管理中心</h2>
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: -15px; margin-bottom: 20px;">https://github.com/ZHAOoops</p>

        <div class="input-group">
            <label for="bank-name">新建/选择题库名称</label>
            <input type="text" id="bank-name" placeholder="例如：大一上物理、大一下数学">
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="switchToInput()">进入题库录入</button>
            <button class="btn btn-info" onclick="importBank()">导入本地题库</button>
        </div>

        <h3>已保存的题库</h3>
        <div class="bank-list" id="bank-list">
            <!-- 题库列表会动态渲染 -->
            <div class="status" id="empty-bank-tip">暂无保存的题库</div>
        </div>
    </div>

    <!-- 题目输入区 -->
    <div class="container input-area" id="input-area">
        <h2>题目录入 - <span id="current-bank-name">未选择题库</span></h2>
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: -15px; margin-bottom: 20px;">https://github.com/ZHAOoops</p>
        <div class="current-bank">
            当前题库：<span id="show-current-bank">无</span>（共 <span id="bank-question-count">0</span> 道题 | 未掌握：<span id="unmastered-count-show">0</span> 道）
        </div>

        <!-- 单题录入 -->
        <div class="input-group">
            <label for="single-question">题目</label>
            <input type="text" id="single-question" placeholder="请输入一道题目...">
        </div>
        <div class="input-group">
            <label for="single-answer">答案</label>
            <input type="text" id="single-answer" placeholder="请输入对应答案...">
        </div>
        <button class="btn btn-primary" onclick="addSingleQuestion()">添加这道题</button>

        <!-- 批量录入 -->
        <div class="input-group" style="margin-top: 20px;">
            <label for="batch-input">批量录入（每行格式：题目|答案，例如：1+1=？|2）</label>
            <textarea id="batch-input" placeholder="示例：
1+1=？|2
水的化学式？|H₂O
什么是HTML？|超文本标记语言"></textarea>
            <div class="tip">每行一道题，题目和答案用竖线 | 分隔</div>
        </div>
        <button class="btn btn-primary" onclick="addBatchQuestions()">批量添加题目</button>

        <!-- 题目设置 -->
        <div class="input-group" style="margin-top: 20px;">
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" name="order-type" id="order-seq" value="seq" checked>
                    <label for="order-seq">顺序出题</label>
                </div>
                <div class="radio-item">
                    <input type="radio" name="order-type" id="order-rand" value="rand">
                    <label for="order-rand">打乱出题</label>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-success" onclick="startReview()" disabled id="start-btn">开始复习</button>
            <button class="btn btn-danger" onclick="clearCurrentBank()">清空当前题库</button>
            <button class="btn btn-info" onclick="exportCurrentBank()">导出全部题目</button>
            <button class="btn btn-warning" onclick="exportCurrentUnmastered()">导出未掌握题目</button>
            <button class="btn btn-secondary" onclick="backToBankManagement()">返回题库管理</button>
        </div>
    </div>

    <!-- 复习区 -->
    <div class="container review-area" id="review-area">
        <h2>题目复习 - <span id="review-bank-name">未选择题库</span></h2>
        <div class="status">当前进度：<span id="current-index">0</span>/<span id="total-count">0</span></div>

        <div class="question-card">
            <div class="question-title" id="current-question">加载中...</div>
            <button class="btn btn-secondary" onclick="toggleAnswer()">查看/隐藏答案</button>
            <div class="answer-content" id="current-answer"></div>
        </div>

        <div class="button-group">
            <button class="btn btn-success" onclick="markMastered()">标记为已掌握</button>
            <button class="btn btn-danger" onclick="markUnmastered()">标记为未掌握</button>
            <button class="btn btn-primary" onclick="nextQuestion()">下一题</button>
            <button class="btn btn-secondary" onclick="backToInput()">返回录入</button>
        </div>

        <div class="status" style="margin-top: 20px;">
            已掌握：<span id="mastered-count">0</span> 道 | 未掌握：<span id="unmastered-count">0</span> 道
        </div>
    </div>

    <!-- 导入文件隐藏输入框 -->
    <input type="file" id="import-file" class="hidden-file-input" accept=".json" onchange="handleFileImport(event)">

    <script>
        // 全局数据
        let allBanks = {}; // 所有题库 { "题库名称": [{question, answer, mastered}, ...], ... }
        let currentBank = ""; // 当前选中的题库名称
        let reviewList = []; // 复习用的题目列表
        let currentReviewIndex = 0; // 当前复习索引

        // 初始化：从本地存储加载所有题库
        window.onload = function() {
            loadFromLocalStorage();
            renderBankList();
            // 默认显示题库管理区
            showArea('bank-management');
        };

        // 本地存储相关函数
        function saveToLocalStorage() {
            localStorage.setItem('questionBanks', JSON.stringify(allBanks));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('questionBanks');
            if (saved) {
                allBanks = JSON.parse(saved);
            } else {
                allBanks = {};
            }
        }

        // 渲染题库列表
        function renderBankList() {
            const bankListEl = document.getElementById('bank-list');
            const emptyTip = document.getElementById('empty-bank-tip');

            // 清空列表
            bankListEl.innerHTML = '';

            // 获取所有题库名称
            const bankNames = Object.keys(allBanks);

            if (bankNames.length === 0) {
                bankListEl.innerHTML = '<div class="status" id="empty-bank-tip">暂无保存的题库</div>';
                return;
            }

            // 渲染每个题库项
            bankNames.forEach(name => {
                const questionCount = allBanks[name]?.length || 0;
                const unmasteredCount = countUnmastered(name);
                const bankItem = document.createElement('div');
                bankItem.className = 'bank-item';
                bankItem.innerHTML = `
                    <span class="bank-name">${name}（${questionCount}道题 | 未掌握：${unmasteredCount}道）</span>
                    <div class="bank-actions">
                        <button class="btn btn-primary" onclick="loadBank('${name}')">加载</button>
                        <button class="btn btn-info" onclick="exportBank('${name}')">导出全部</button>
                        <button class="btn btn-warning" onclick="exportUnmastered('${name}')">导出未掌握</button>
                        <button class="btn btn-danger" onclick="deleteBank('${name}')">删除</button>
                    </div>
                `;
                bankListEl.appendChild(bankItem);
            });
        }

        // 统计指定题库的未掌握题目数量
        function countUnmastered(bankName) {
            if (!allBanks[bankName]) return 0;
            return allBanks[bankName].filter(q => q.mastered === false).length;
        }

        // 切换显示区域（题库管理/录入/复习）
        function showArea(areaName) {
            // 隐藏所有区域
            document.getElementById('bank-management').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('review-area').style.display = 'none';
            // 显示目标区域
            document.getElementById(areaName).style.display = 'block';
        }

        // 切换到录入区
        function switchToInput() {
            const bankName = document.getElementById('bank-name').value.trim();
            if (!bankName) {
                alert('请输入题库名称！');
                return;
            }

            // 如果题库不存在，创建空题库
            if (!allBanks[bankName]) {
                allBanks[bankName] = [];
                saveToLocalStorage();
                renderBankList();
            }

            // 设置当前题库
            currentBank = bankName;
            document.getElementById('current-bank-name').textContent = bankName;
            document.getElementById('show-current-bank').textContent = bankName;
            updateBankQuestionCount();

            // 启用开始复习按钮（如果有题目）
            document.getElementById('start-btn').disabled = allBanks[currentBank].length === 0;

            // 显示录入区
            showArea('input-area');
        }

        // 加载指定题库
        function loadBank(bankName) {
            document.getElementById('bank-name').value = bankName;
            switchToInput();
        }

        // 返回题库管理
        function backToBankManagement() {
            showArea('bank-management');
        }

        // 返回录入区（从复习区）
        function backToInput() {
            showArea('input-area');
            document.getElementById('review-bank-name').textContent = currentBank;
            updateBankQuestionCount(); // 刷新未掌握数量显示
        }

        // 更新当前题库题目数量和未掌握数量
        function updateBankQuestionCount() {
            const count = allBanks[currentBank]?.length || 0;
            const unmasteredCount = countUnmastered(currentBank);
            document.getElementById('bank-question-count').textContent = count;
            document.getElementById('unmastered-count-show').textContent = unmasteredCount;
            document.getElementById('start-btn').disabled = count === 0;
        }

        // 添加单道题目
        function addSingleQuestion() {
            const question = document.getElementById('single-question').value.trim();
            const answer = document.getElementById('single-answer').value.trim();

            if (!question || !answer) {
                alert('题目和答案都不能为空！');
                return;
            }

            // 添加到当前题库
            allBanks[currentBank].push({
                question: question,
                answer: answer,
                mastered: null // null=未标记，true=已掌握，false=未掌握
            });

            // 保存到本地
            saveToLocalStorage();

            // 清空输入框
            document.getElementById('single-question').value = '';
            document.getElementById('single-answer').value = '';

            // 更新数量
            updateBankQuestionCount();
            renderBankList(); // 刷新题库列表的未掌握数量

            alert('题目添加成功！');
        }

        // 批量添加题目
        function addBatchQuestions() {
            const batchText = document.getElementById('batch-input').value.trim();
            if (!batchText) {
                alert('批量输入内容不能为空！');
                return;
            }

            const lines = batchText.split('\n');
            let successCount = 0;
            let errorLines = [];

            lines.forEach((line, index) => {
                const trimedLine = line.trim();
                if (!trimedLine) return; // 跳过空行

                const [question, answer] = trimedLine.split('|');
                if (!question || !answer) {
                    errorLines.push(index + 1); // 记录错误行号
                    return;
                }

                // 添加有效题目
                allBanks[currentBank].push({
                    question: question.trim(),
                    answer: answer.trim(),
                    mastered: null
                });
                successCount++;
            });

            // 清空批量输入框
            document.getElementById('batch-input').value = '';

            // 保存到本地
            saveToLocalStorage();

            // 更新统计
            updateBankQuestionCount();
            renderBankList(); // 刷新题库列表的未掌握数量

            // 提示结果
            let tip = `批量添加完成！成功添加 ${successCount} 道题`;
            if (errorLines.length > 0) {
                tip += `，第 ${errorLines.join(',')} 行格式错误（请检查是否用 | 分隔）`;
            }
            alert(tip);
        }

        // 清空当前题库
        function clearCurrentBank() {
            if (confirm(`确定要清空【${currentBank}】题库的所有题目吗？`)) {
                allBanks[currentBank] = [];
                saveToLocalStorage();
                updateBankQuestionCount();
                renderBankList();
                alert('题库已清空！');
            }
        }

        // 删除指定题库
        function deleteBank(bankName) {
            if (confirm(`确定要删除【${bankName}】整个题库吗？删除后无法恢复！`)) {
                delete allBanks[bankName];
                saveToLocalStorage();
                renderBankList();
                // 如果删除的是当前题库，重置
                if (currentBank === bankName) {
                    currentBank = "";
                }
                alert('题库已删除！');
            }
        }

        // 导出当前题库全部题目
        function exportCurrentBank() {
            exportBank(currentBank);
        }

        // 导出指定题库全部题目
        function exportBank(bankName) {
            if (!allBanks[bankName]) {
                alert('该题库不存在！');
                return;
            }

            // 构造导出数据
            const exportData = {
                name: bankName,
                type: "全部题目",
                questions: allBanks[bankName],
                exportTime: new Date().toLocaleString()
            };

            // 创建JSON文件
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // 创建下载链接
            const a = document.createElement('a');
            a.href = url;
            a.download = `${bankName}_全部题目_${new Date().getTime()}.json`;
            a.click();

            // 释放URL
            URL.revokeObjectURL(url);
            alert(`【${bankName}】全部题目已导出到本地！共 ${allBanks[bankName].length} 道题`);
        }

        // 导出当前题库未掌握题目
        function exportCurrentUnmastered() {
            exportUnmastered(currentBank);
        }

        // 导出指定题库未掌握题目
        function exportUnmastered(bankName) {
            if (!allBanks[bankName]) {
                alert('该题库不存在！');
                return;
            }

            // 筛选未掌握题目（mastered === false）
            const unmasteredQuestions = allBanks[bankName].filter(q => q.mastered === false);

            if (unmasteredQuestions.length === 0) {
                alert(`【${bankName}】题库中暂无未掌握的题目！`);
                return;
            }

            // 构造导出数据
            const exportData = {
                name: bankName,
                type: "未掌握题目",
                questions: unmasteredQuestions,
                exportTime: new Date().toLocaleString(),
                totalUnmastered: unmasteredQuestions.length
            };

            // 创建JSON文件
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // 创建下载链接
            const a = document.createElement('a');
            a.href = url;
            a.download = `${bankName}_未掌握题目_${new Date().getTime()}.json`;
            a.click();

            // 释放URL
            URL.revokeObjectURL(url);
            alert(`【${bankName}】未掌握题目已导出到本地！共 ${unmasteredQuestions.length} 道题`);
        }

        // 导入本地题库
        function importBank() {
            document.getElementById('import-file').click();
        }

        // 处理文件导入
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 检查文件类型
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert('请导入JSON格式的题库文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);

                    // 验证数据格式
                    if (!importData.name || !Array.isArray(importData.questions)) {
                        throw new Error('题库文件格式错误');
                    }

                    // 检查题库名称是否已存在
                    if (allBanks[importData.name]) {
                        if (!confirm(`【${importData.name}】题库已存在，是否覆盖？`)) {
                            return;
                        }
                    }

                    // 保存导入的题库
                    allBanks[importData.name] = importData.questions;
                    saveToLocalStorage();
                    renderBankList();

                    alert(`【${importData.name}】题库导入成功！共 ${importData.questions.length} 道题`);
                    // 清空文件输入框
                    document.getElementById('import-file').value = '';
                } catch (err) {
                    alert('导入失败：' + err.message);
                    document.getElementById('import-file').value = '';
                }
            };
            reader.readAsText(file);
        }

        // 开始复习
        function startReview() {
            if (!currentBank || allBanks[currentBank].length === 0) {
                alert('题库中没有题目！');
                return;
            }

            // 复制题目列表（避免修改原数据）
            reviewList = [...allBanks[currentBank]];

            // 判断是否打乱
            const isRandom = document.querySelector('input[name="order-type"]:checked').value === 'rand';
            if (isRandom) {
                // Fisher-Yates 洗牌算法
                for (let i = reviewList.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [reviewList[i], reviewList[j]] = [reviewList[j], reviewList[i]];
                }
            }

            // 重置复习状态
            currentReviewIndex = 0;

            // 切换到复习区
            showArea('review-area');
            document.getElementById('review-bank-name').textContent = currentBank;

            // 加载第一道题
            loadCurrentQuestion();
            updateReviewStatus();
        }

        // 加载当前题目
        function loadCurrentQuestion() {
            if (reviewList.length === 0) return;

            const currentQ = reviewList[currentReviewIndex];
            document.getElementById('current-question').textContent = currentQ.question;
            document.getElementById('current-answer').textContent = currentQ.answer;
            // 隐藏答案
            document.getElementById('current-answer').style.display = 'none';

            // 更新进度
            document.getElementById('current-index').textContent = currentReviewIndex + 1;
            document.getElementById('total-count').textContent = reviewList.length;
        }

        // 切换答案显示/隐藏
        function toggleAnswer() {
            const answerEl = document.getElementById('current-answer');
            answerEl.style.display = answerEl.style.display === 'none' ? 'block' : 'none';
        }

        // 标记为已掌握
        function markMastered() {
            reviewList[currentReviewIndex].mastered = true;
            // 同步更新原题库数据
            const originalIndex = allBanks[currentBank].findIndex(q =>
                q.question === reviewList[currentReviewIndex].question &&
                q.answer === reviewList[currentReviewIndex].answer
            );
            if (originalIndex !== -1) {
                allBanks[currentBank][originalIndex].mastered = true;
                saveToLocalStorage();
            }
            updateReviewStatus();
            alert('已标记为【已掌握】！');
        }

        // 标记为未掌握
        function markUnmastered() {
            reviewList[currentReviewIndex].mastered = false;
            // 同步更新原题库数据
            const originalIndex = allBanks[currentBank].findIndex(q =>
                q.question === reviewList[currentReviewIndex].question &&
                q.answer === reviewList[currentReviewIndex].answer
            );
            if (originalIndex !== -1) {
                allBanks[currentBank][originalIndex].mastered = false;
                saveToLocalStorage();
            }
            updateReviewStatus();
            alert('已标记为【未掌握】！');
        }

        // 更新复习状态统计
        function updateReviewStatus() {
            const mastered = reviewList.filter(q => q.mastered === true).length;
            const unmastered = reviewList.filter(q => q.mastered === false).length;

            document.getElementById('mastered-count').textContent = mastered;
            document.getElementById('unmastered-count').textContent = unmastered;
        }

        // 下一题
        function nextQuestion() {
            if (currentReviewIndex < reviewList.length - 1) {
                currentReviewIndex++;
                loadCurrentQuestion();
            } else {
                // 复习完成
                if (confirm('已经复习完所有题目！是否返回录入页面？')) {
                    backToInput();
                }
            }
        }
    </script>
</body>
</html>